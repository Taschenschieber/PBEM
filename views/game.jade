extend layout

mixin logs(game)
  table#logs-table
    - for(var i = game.logs.length-1; i >= 0; i--)
      if game.logs[i].empty
        tr
          th(colspan=20) No actions taken
      tr
        th(colspan=20)
          a(href="/logfiles/"+game._id+"/"+game.logs[i].id)
            span.glyphicon.glyphicon-floppy-save 
          | &nbsp;Log #
          = i

      tr
        td
          if(game.logs[i].sentBy == game.playerA)
            img(src=avatarAsmall)
          else if(game.logs[i].sentBy == game.playerB)
            img(src=avatarBsmall)
        td
          | Submitted by 
          = game.logs[i].sentBy
          | , 
          = game.logs[i].prettyDate || game.logs[i].date
        td
          | Covers&nbsp;
          != game.logs[i].prettyFirstPhase
          | &nbsp;through&nbsp;
          != game.logs[i].prettyLastPhase
      tr#bottom
        td(colspan=20)#message
          if game.logs[i].message
            p= game.logs[i].message
          else
            p: i No message was sent with this log file.


block secondary-nav
  include secondary-nav-games
  
block content
  h1
    if game.scenario && game.scenario.number
      = game.scenario.number
      small= " "+(game.scenario.title || "Unknown Scenario")
    else
      | Custom Scenario
      
  table.game-header(width="100%")
    tr
      td(width="80px" rowspan="4"): img(src=avatarA)
      th(width="*"): a(href="/user/"+game.playerA)= game.playerA
      th(width="*"): a(href="/user/"+game.playerB)= game.playerB
      td(width="80px" rowspan="4"): img(src=avatarB)
    if game.whoIsAttacker == "A" 
      tr
        td Scenario Attacker
        td Scenario Defender
      tr
        if (scenario && scenario.defender && scenario.attacker)
          td= scenario.defender.nation
          td= scenario.attacker.nation
        else
          td ???
          td ???
    else if game.whoIsAttacker == "B"
      tr
        td Scenario Defender
        td Scenario Attacker
      tr
        if (scenario && scenario.defender && scenario.attacker)
          td= scenario.defender.nation
          td= scenario.attacker.nation
        else
          td ???
          td ???
    else
      tr
        td ???
        td ???
      tr
        td ???
        td ???

    tr
      if(game.whoseTurn == "A")
        td.active-player Active Player
        td
      else if(game.whoseTurn == "B")
        td
        td.active-player Active Player
      else
        td
        td
        
        
  if game.logs.length == 0
    p 
      | This game has no logs so far. 
      a(href="/game/"+game._id+"/upload") Upload a log to start the game!
  
  else
    if req && req.user
      - var isactive = false
      if (activePlayer == req.user.name)
        - isactive = true
        p 
          | It is your turn to move. 
      else if(activePlayer == "")
        p
          | Invalid data. The software can not determine whose turn it is. If it is your turn, 
          a(href="/game/"+game._id+"/upload") click here
          | &nbsp;to continue the game.  
      else
        p
          | It is 
          a(href="/user/"+activePlayer)= activePlayer
          | 's turn to move.
      p
        a.btn.btn-info.active(href="/logfiles/"+game._id+"/"+game.logs[game.logs.length -1]._id) Download latest log
        | &nbsp;
        if game.result == "ongoing"
          if isactive
            a.btn.btn-primary.btn-large.active(href="/game/"+game._id+"/upload", role="button") Upload log 
          | &nbsp;
          a.btn.btn-danger.btn-large.active(href="/game/"+game._id+"/resign", role="button") Resign
    else      
      p
        | It is
        a(href="/user/"+activePlayer)= activePlayer
        | 's turn to move.
          
    +logs(game)
    